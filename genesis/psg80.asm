        ;; Z80 PSG Sound Driver test.
        org     0
        defc    psg=$7f11

rst_0:  di
        im      1
        ld      sp, $2000
        ei
rst_lp: jr      rst_lp

        defs    $20-ASMPC

ptr:    defw    song
vol:    defb    $1f, $1f, $1f
wait:   defb    $01

        defs    $38-ASMPC

rst_38: push    af
        push    de
        push    hl
        ld      de, psg
        ld      hl, wait
        dec     (hl)
        jr      nz, decay
        ld      hl, (ptr)
        ld      a, (hl)
        and     a
        jr      nz, nolp
        ld      hl, signum
        ld      a, (hl)
nolp:   ld      (wait), a
        inc     hl
        ld      a, (hl)
        inc     hl
        and     a
        jr      z, v2
        ;; Voice 1
        ld      (de), a
        ld      a, (hl)
        inc     hl
        ld      (de), a
        ld      a, 7
        ld      (vol),a
        ;; Voice 2
v2:     ld      a, (hl)
        inc     hl
        and     a
        jr      z, v3
        ld      (de), a
        ld      a, (hl)
        inc     hl
        ld      (de), a
        ld      a, 7
        ld      (vol+1), a
        ;; Voice 3
v3:     ld      a, (hl)
        inc     hl
        and     a
        jr      z, vdone
        ld      (de), a
        ld      a, (hl)
        inc     hl
        ld      (de), a
        ld      a, 7
        ld      (vol+2), a
vdone:  ld      (ptr), hl
decay:  ld      a, (vol)
        cp      a, $1f
        jr      z, nodec1
        inc     a
        ld      (vol), a
nodec1: srl     a
        or      $90
        ld      (de), a
        ld      a, (vol+1)
        cp      a, $1f
        jr      z, nodec2
        inc     a
        ld      (vol+1), a
nodec2: srl     a
        or      $b0
        ld      (de), a
        ld      a, (vol+2)
        cp      a, $1f
        jr      z, nodec3
        inc     a
        ld      (vol+2), a
nodec3: srl     a
        or      $d0
        ld      (de), a

        pop     hl
        pop     de
        pop     af
        ei
        ret

song:   defb    $08,$00,$a5,$05,$00,$08,$00,$a0,$05,$00,$10,$00,$a7,$04,$00,$10
        defb    $00,$a5,$03,$00,$08,$00,$a5,$05,$00,$08,$00,$a0,$05,$00,$08,$00
        defb    $a7,$04,$00,$08,$00,$a5,$03,$00,$08,$00,$a0,$03,$00,$08,$00,$aa
        defb    $02,$00,$08,$00,$a0,$03,$00,$08,$00,$a9,$03,$00,$10,$00,$a5,$03
        defb    $00,$10,$00,$a7,$04,$00,$08,$00,$a5,$05,$00,$08,$00,$a0,$05,$00
        defb    $10,$00,$a7,$04,$00,$10,$00,$a5,$03,$00,$08,$00,$a0,$03,$00,$08
        defb    $00,$a9,$03,$00,$08,$00,$a5,$03,$00,$08,$00,$a0,$03,$00,$08,$00
        defb    $a8,$02,$00,$08,$00,$aa,$02,$00,$08,$00,$a8,$02,$00,$08,$00,$a0
        defb    $03,$00
signum: defb    $10,$8f,$08,$a1,$50,$cd,$1f,$10,$8f,$07,$ad,$1f,$c0,$14,$08,$8a
        defb    $0a,$a6,$47,$00,$08,$8a,$0a,$00,$00,$08,$00,$ab,$23,$cd,$17,$08
        defb    $86,$0d,$00,$00,$08,$84,$0b,$ae,$6a,$00,$08,$8e,$0b,$00,$00,$10
        defb    $86,$0d,$ad,$1f,$c8,$16,$10,$86,$0d,$a2,$7f,$00,$10,$8e,$0b,$ad
        defb    $1f,$cd,$11,$10,$84,$0b,$a4,$5f,$cd,$25,$08,$84,$0b,$a1,$28,$cc
        defb    $1a,$08,$8e,$0b,$00,$00,$08,$86,$0d,$a6,$47,$c1,$28,$08,$8e,$0b
        defb    $00,$00,$08,$8a,$0a,$ab,$23,$c0,$14,$08,$8f,$08,$00,$00,$08,$8f
        defb    $07,$ae,$6a,$00,$08,$8a,$0a,$00,$00,$08,$8f,$08,$ab,$23,$c3,$15
        defb    $08,$8e,$0b,$00,$00,$08,$8a,$0a,$ae,$54,$00,$08,$86,$0d,$00,$00
        defb    $08,$8e,$0b,$a0,$1e,$c3,$15,$08,$86,$0d,$00,$00,$10,$8a,$0a,$a1
        defb    $50,$cd,$1f,$10,$8f,$08,$ad,$1f,$c0,$14,$08,$8f,$07,$a6,$47,$00
        defb    $08,$8a,$0a,$00,$00,$08,$8f,$08,$ab,$23,$cd,$17,$08,$8e,$0b,$00
        defb    $00,$08,$8a,$0a,$ae,$6a,$00,$08,$86,$0d,$00,$00,$08,$84,$0b,$ad
        defb    $1f,$c8,$16,$08,$8a,$0a,$00,$00,$08,$84,$0b,$a9,$3f,$00,$08,$8e
        defb    $0b,$00,$00,$08,$86,$0d,$ad,$1f,$cd,$11,$08,$8e,$0b,$00,$00,$10
        defb    $84,$0b,$a4,$5f,$cd,$25,$08,$86,$0d,$a1,$28,$cc,$1a,$08,$8e,$0b
        defb    $00,$00,$08,$8a,$0a,$a6,$47,$c0,$14,$08,$8f,$08,$00,$00,$08,$8e
        defb    $0b,$ab,$23,$c0,$14,$08,$8a,$0a,$00,$00,$08,$8e,$0b,$ae,$6a,$c7
        defb    $2a,$08,$86,$0d,$00,$00,$10,$8e,$0b,$a4,$5f,$c1,$28,$10,$86,$0d
        defb    $ae,$59,$cd,$25,$10,$8e,$0b,$ae,$54,$cb,$23,$10,$8f,$08,$a1,$50
        defb    $cd,$1f,$10,$8f,$07,$ad,$1f,$c0,$14,$08,$8a,$0a,$a6,$47,$00,$08
        defb    $8a,$0a,$00,$00,$08,$00,$ab,$23,$cd,$17,$08,$86,$0d,$00,$00,$08
        defb    $84,$0b,$ae,$6a,$00,$08,$8e,$0b,$00,$00,$10,$86,$0d,$ad,$1f,$c8
        defb    $16,$10,$86,$0d,$a2,$7f,$00,$10,$8e,$0b,$ad,$1f,$cd,$11,$10,$84
        defb    $0b,$a4,$5f,$cd,$25,$08,$84,$0b,$a1,$28,$cc,$1a,$08,$8e,$0b,$00
        defb    $00,$08,$86,$0d,$a6,$47,$c1,$28,$08,$8e,$0b,$00,$00,$08,$8a,$0a
        defb    $ab,$23,$c0,$14,$08,$8f,$08,$00,$00,$08,$8f,$07,$ae,$6a,$00,$08
        defb    $8a,$0a,$00,$00,$08,$8f,$08,$ab,$23,$c3,$15,$08,$8e,$0b,$00,$00
        defb    $08,$8a,$0a,$ae,$54,$00,$08,$86,$0d,$00,$00,$08,$8e,$0b,$a0,$1e
        defb    $c3,$15,$08,$86,$0d,$00,$00,$10,$8a,$0a,$a1,$50,$cd,$1f,$10,$8f
        defb    $08,$ad,$1f,$c0,$14,$08,$8f,$07,$a6,$47,$00,$08,$8a,$0a,$00,$00
        defb    $08,$8f,$08,$ab,$23,$cd,$17,$08,$8e,$0b,$00,$00,$08,$8a,$0a,$ae
        defb    $6a,$00,$08,$86,$0d,$00,$00,$08,$84,$0b,$ad,$1f,$c8,$16,$08,$8a
        defb    $0a,$00,$00,$08,$84,$0b,$a9,$3f,$00,$08,$8e,$0b,$00,$00,$08,$86
        defb    $0d,$ad,$1f,$cd,$11,$08,$8e,$0b,$00,$00,$10,$84,$0b,$a4,$5f,$cd
        defb    $25,$08,$86,$0d,$a1,$28,$cc,$1a,$08,$8e,$0b,$00,$00,$08,$8a,$0a
        defb    $a6,$47,$c0,$14,$08,$8f,$08,$00,$00,$08,$8e,$0b,$ab,$23,$c0,$14
        defb    $08,$8a,$0a,$00,$00,$08,$8e,$0b,$ae,$6a,$c7,$2a,$08,$86,$0d,$00
        defb    $00,$10,$8e,$0b,$a4,$5f,$c1,$28,$10,$86,$0d,$ae,$59,$cd,$25,$10
        defb    $8e,$0b,$ae,$54,$cb,$23,$10,$86,$0d,$a1,$50,$cd,$1f,$08,$8d,$11
        defb    $ad,$1f,$c0,$14,$08,$8e,$0f,$00,$00,$10,$86,$0d,$ae,$6a,$00,$08
        defb    $8d,$11,$ad,$1f,$c0,$14,$08,$8e,$0f,$00,$00,$08,$86,$0d,$ae,$54
        defb    $00,$08,$8e,$0b,$00,$00,$08,$8a,$0a,$ab,$23,$c0,$14,$08,$86,$0d
        defb    $00,$00,$08,$80,$0a,$a9,$3f,$00,$08,$8a,$0a,$00,$00,$08,$80,$0a
        defb    $ab,$23,$c0,$14,$08,$8f,$08,$00,$00,$10,$86,$0d,$a4,$5f,$c1,$28
        defb    $10,$86,$0d,$ad,$1f,$c0,$14,$08,$8d,$11,$a2,$7f,$00,$08,$8e,$0f
        defb    $00,$00,$08,$86,$0d,$ad,$1f,$c0,$14,$08,$8d,$11,$00,$00,$08,$80
        defb    $0a,$ae,$6a,$c7,$2a,$08,$8a,$0a,$00,$00,$08,$8e,$0b,$ab,$23,$c3
        defb    $15,$08,$86,$0d,$00,$00,$08,$8d,$11,$ae,$54,$cb,$23,$08,$83,$15
        defb    $00,$00,$08,$80,$14,$ab,$23,$cc,$1a,$08,$8d,$11,$00,$00,$10,$86
        defb    $0d,$a1,$50,$cd,$1f,$08,$8d,$11,$ad,$1f,$c0,$14,$08,$8e,$0f,$00
        defb    $00,$10,$86,$0d,$ae,$6a,$00,$08,$8d,$11,$ad,$1f,$c0,$14,$08,$8e
        defb    $0f,$00,$00,$08,$86,$0d,$ae,$54,$00,$08,$86,$0d,$00,$00,$08,$8e
        defb    $0b,$ab,$23,$c3,$15,$08,$8a,$0a,$00,$00,$08,$86,$0d,$a9,$3f,$00
        defb    $08,$8d,$11,$00,$00,$08,$8e,$0f,$ab,$23,$c3,$15,$08,$8d,$11,$00
        defb    $00,$10,$86,$0d,$a4,$5f,$c1,$28,$08,$86,$0d,$ad,$1f,$c0,$14,$08
        defb    $83,$0e,$00,$00,$08,$86,$0d,$a2,$7f,$00,$08,$8d,$11,$00,$00,$08
        defb    $8e,$0f,$ad,$1f,$c0,$14,$08,$86,$0d,$00,$00,$08,$80,$0a,$ae,$6a
        defb    $c7,$2a,$08,$8a,$0a,$00,$00,$08,$80,$0a,$a4,$5f,$c1,$28,$08,$8f
        defb    $08,$00,$00,$10,$86,$0d,$ae,$54,$cb,$23,$10,$83,$0e,$ae,$54,$cb
        defb    $21,$10,$86,$0d,$a1,$50,$cd,$1f,$08,$8d,$11,$ad,$1f,$c0,$14,$08
        defb    $8e,$0f,$00,$00,$10,$86,$0d,$ae,$6a,$00,$08,$8d,$11,$ad,$1f,$c0
        defb    $14,$08,$8e,$0f,$00,$00,$08,$86,$0d,$ae,$54,$00,$08,$8e,$0b,$00
        defb    $00,$08,$8a,$0a,$ab,$23,$c0,$14,$08,$86,$0d,$00,$00,$08,$80,$0a
        defb    $a9,$3f,$00,$08,$8a,$0a,$00,$00,$08,$80,$0a,$ab,$23,$c0,$14,$08
        defb    $8f,$08,$00,$00,$10,$86,$0d,$a4,$5f,$c1,$28,$10,$86,$0d,$ad,$1f
        defb    $c0,$14,$08,$8d,$11,$a2,$7f,$00,$08,$8e,$0f,$00,$00,$08,$86,$0d
        defb    $ad,$1f,$c0,$14,$08,$8d,$11,$00,$00,$08,$80,$0a,$ae,$6a,$c7,$2a
        defb    $08,$8a,$0a,$00,$00,$08,$8e,$0b,$ab,$23,$c3,$15,$08,$86,$0d,$00
        defb    $00,$08,$8d,$11,$ae,$54,$cb,$23,$08,$83,$15,$00,$00,$08,$80,$14
        defb    $ab,$23,$cc,$1a,$08,$8d,$11,$00,$00,$10,$86,$0d,$a1,$50,$cd,$1f
        defb    $08,$8d,$11,$ad,$1f,$c0,$14,$08,$8e,$0f,$00,$00,$10,$86,$0d,$ae
        defb    $6a,$00,$08,$8d,$11,$ad,$1f,$c0,$14,$08,$8e,$0f,$00,$00,$08,$86
        defb    $0d,$ae,$54,$00,$08,$86,$0d,$00,$00,$08,$8e,$0b,$ab,$23,$c3,$15
        defb    $08,$8a,$0a,$00,$00,$08,$86,$0d,$a9,$3f,$00,$08,$8d,$11,$00,$00
        defb    $08,$8e,$0f,$ab,$23,$c3,$15,$08,$8d,$11,$00,$00,$10,$86,$0d,$a4
        defb    $5f,$c1,$28,$08,$86,$0d,$ad,$1f,$c0,$14,$08,$83,$0e,$00,$00,$08
        defb    $86,$0d,$a2,$7f,$00,$08,$8d,$11,$00,$00,$08,$8e,$0f,$ad,$1f,$c0
        defb    $14,$08,$86,$0d,$00,$00,$08,$80,$0a,$ae,$6a,$c7,$2a,$08,$8a,$0a
        defb    $00,$00,$08,$80,$0a,$a4,$5f,$c1,$28,$08,$8f,$08,$00,$00,$10,$86
        defb    $0d,$ae,$59,$cd,$25,$10,$8e,$0b,$ae,$54,$cb,$23,$00
